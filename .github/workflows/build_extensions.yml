name: Build and Publish Neo Extensions

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_unchanged:
        description: 'Skip release if content is unchanged'
        required: true
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: silex/emacs:30-debian-ci-eask

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Set Commit SHA
        run: echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
  
      - name: Get latest release asset (if any)
        id: get_release
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const release = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            }).catch(() => null);
            return release?.data?.assets?.find(a => a.name.startsWith("extensions-") && a.name.endsWith(".el"))?.browser_download_url || "";

      - name: Download previous release file
        if: steps.get_release.outputs.result != ''
        run: curl -fsSL "${{ steps.get_release.outputs.result }}" -o old.el

      - name: Export OLD_MANIFEST (if old.el exists)
        run: |
          if [ -f old.el ]; then
            echo "OLD_MANIFEST=$PWD/old.el" >> "$GITHUB_ENV"
          fi

      - name: Run Emacs batch to generate dist/extensions-${{ env.COMMIT_SHA }}.el and dist/extensions-${{ env.COMMIT_SHA }}.el.sha256
        run: |
          mkdir -p dist
          emacs --batch -l build/extensions.el ${{ env.COMMIT_SHA }}

      - name: Verify checksum
        run: |
          SHA_CALC=$(sha256sum dist/extensions-${{ env.COMMIT_SHA }}.el | cut -d' ' -f1)
          SHA_FILE=$(cat dist/extensions-${{ env.COMMIT_SHA }}.el.sha256)
          if [ "$SHA_CALC" != "$SHA_FILE" ]; then
            echo "Checksum mismatch: calculated $SHA_CALC, expected $SHA_FILE"
            exit 1
          fi
          echo "Checksum verified: $SHA_CALC"

      - name: Compare outputs
        id: compare
        env:
          SKIP_UNCHANGED: ${{ inputs.skip_unchanged || 'false' }}
        run: |
          if [ "$SKIP_UNCHANGED" = "true" ] && [ -f old.el ] && cmp -s dist/extensions-${{ env.COMMIT_SHA }}.el old.el; then
            echo "Unchanged and skip_unchanged is true - skipping release"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "Changed or skip_unchanged is false - will release"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        if: steps.compare.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Auto Release
          body: Auto-generated by GitHub Actions
          files: |
            dist/extensions-${{ env.COMMIT_SHA }}.el
            dist/extensions-${{ env.COMMIT_SHA }}.el.sha256
